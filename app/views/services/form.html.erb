<div class="registration-form">
<%= form_tag service_form_submit_path(@issue) do |f| %>
    <div class="form-icon" style="background: none;">
        <img src="https://www.dcsnetworks.sg/uploads/7/9/4/7/79473268/6711601.jpg" />
    </div>
    <div class="form-group">
        <p>
            <label>Service Date:</label> <span><b><%= Time.now.in_time_zone("Singapore").strftime("%d-%m-%Y") %></b></span>
        </p>
    </div>
    <div class="form-group">
        <p>
            <label>Our Ref Number:</label> <span><b>#<%= @issue.id %></b></span>
        </p>
    </div>
    <% custom_field_values = @issue.editable_custom_field_values %>
    <% custom_field_values_full_width = custom_field_values.select { |value| value.custom_field.full_width_layout? } %>
    <% custom_field_values -= custom_field_values_full_width %>
    <% if custom_field_values.present? %>
      <% i = 0 %>
      <% split_on = (custom_field_values.size / 2.0).ceil - 1 %>
      <% custom_field_values.each do |value| %>
      <% if Setting.plugin_redmine_services['company_fields'].include?(value.custom_field_id.to_s) %>
        <div class="form-group">
            <p>
                <label><%= value.custom_field.name %>:</label> <span><b><%= value.value %></b></span>
            </p>
        </div>
      <% end %>
      <% end %>
    <div class="form-group">
        <p style="text-align: right;padding: 0;margin: 0;"><span><b>Chargeable: <font color="red"><%= @issue.custom_field_value(8) %></font></b></span></p>
        <p style="border: 2px solid;padding: 10px;">
            <label>Description issue/problem:</label> 
            <span><b><%= textilizable(@issue, :description, :only_path => false) %></b></span>
        </p>
    </div>
    <% if @issue.attachments.present? %>
    <div class="form-group">
        <div class="form-group" id="attachments_link">
            <p><%= render :partial => 'attachments/customer_links', :locals => {:attachments => @issue.attachments, container: @issue } %></p>
        </div>
    </div>
    <% end %>
      <% 
        i = 0
        custom_field_values.each do |value| 
      %>
      <% if @issue.check_in_time.present? && Setting.plugin_redmine_services['servant_fields'].include?(value.custom_field_id.to_s) %>
        <div class="form-group">
            <% if i == 0 %>
                <p style="text-align: right;padding: 0;margin: 0;"><span><b>Services Status: <font color="red">
                    <% 
                        sts = IssueStatus.where(id: @issue.tracker.issue_status_ids)
                    %>
                    <%= select_tag("issue[status_id]", options_from_collection_for_select(sts, "id", "name",@issue.status_id)) %>
                </font></b></span></p>
            <% end %>
            <%= custom_field_tag_with_label :issue, value, {:required => true, class: 'form-control item'} %>
            <% if i == 0 %>
                <p><b>Acknowledgment: </b></p>
            <% end %>
            <% i = i +1 %>
        </div>
      <% end -%>
    <% end -%>
    <% end %>
    <% if @issue.check_in_time.present? %>
    <div class="form-group" id="new-attachments" style="display:inline-block;">
        <label><b>Attachments</b></label>
        <p><%= render :partial => 'attachments/settings_form', :locals => {:container => @issue } %></p>
    </div>
    <div class="form-group">
      <label class="block font-medium">Signature:</label>

      <canvas id="signature-canvas" class="border rounded" width="400" height="200"></canvas>

      <%= button_tag 'Clear', type: 'button', id: 'clear-canvas', class: 'mt-2 text-sm text-blue-600 hover:underline' %>

      <!-- Hidden field to store the base64 signature -->
      <%= hidden_field_tag :signature_data %>
    </div>
    <div class="form-group">
        <p>Check-in Time: <%= @issue.checkin_time("Singapore") %></p>
        <p>Services By: <%= @issue.assigned_to.try(:name) %></p>
        <input type="submit" id="submit_button" class="btn btn-block create-account" value="Submit">
    </div>
    <% else %>
        <a href="<%= service_form_checkin_path(issue_id: params[:issue_id]) %>" class="btn btn-block create-account" onclick="return confirm('Are you sure want to check-in')">Check-in</a>
    <% end %>
    <% end %>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const form = document.querySelector('form');
  if (!form) return;

  const cf17 = document.getElementById('issue_custom_field_values_17'); // select
  const cf9  = document.getElementById('issue_custom_field_values_9');  // textarea

  // 1) Make ALL fields required (except file inputs)
  document.querySelectorAll('input, textarea, select').forEach(function (el) {
    if (el.tagName === 'INPUT' && el.type === 'file') return;
    el.required = true;
  });

  // 2) But for these two: remove required (because we want OR rule)
  if (cf17) cf17.required = false;
  if (cf9)  cf9.required  = false;

  // Helper: check value
  function hasValue(el) {
    if (!el) return false;
    return String(el.value || '').trim().length > 0;
  }

  // 3) OR validation: at least one of cf17/cf9 must be filled
  function validateEither() {
    const ok = hasValue(cf17) || hasValue(cf9);

    const msg = ok ? '' : 'Please fill Standard Answer OR Solution Update.';

    // Set validity on both so the browser can show message near either field
    if (cf17) cf17.setCustomValidity(msg);
    if (cf9)  cf9.setCustomValidity(msg);

    return ok;
  }

  // Live validation so message clears immediately
  if (cf17) cf17.addEventListener('change', validateEither);
  if (cf9)  cf9.addEventListener('input', validateEither);

  // 4) Signature validation (your existing logic)
  const canvas = document.getElementById('signature-canvas');

  function isCanvasBlank(canvas) {
    const blank = document.createElement('canvas');
    blank.width = canvas.width;
    blank.height = canvas.height;
    return canvas.toDataURL() === blank.toDataURL();
  }

  // Initial validate (so if both empty, the custom message is ready)
  validateEither();

  form.addEventListener('submit', function (e) {
    // run OR validation
    validateEither();

    // If any required field fails (including our custom validity), block submit
    if (!form.checkValidity()) {
      e.preventDefault();
      form.reportValidity();
      return;
    }

    // Signature check
    if (canvas && isCanvasBlank(canvas)) {
      e.preventDefault();
      alert('Please provide your signature before submitting.');
      return;
    }

    // Disable button + processing text (donâ€™t call form.submit() again)
    const sbtn = document.getElementById('submit_button');
    if (sbtn) {
      sbtn.value = 'Processing...';
      sbtn.disabled = true;
    }
  });
});
</script>
